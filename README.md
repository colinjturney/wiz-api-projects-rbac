# Wiz API Projects and RBAC Setup Automation

# Disclaimer - PLEASE READ

By using this software and associated documentation files (the “Software”) you hereby agree and understand that:

1. The use of the Software is free of charge and may only be used by Wiz customers for its internal purposes.
2. The Software should not be distributed to third parties.
3. The Software is not part of Wiz’s Services and is not subject to your company’s services agreement with Wiz.
4. THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL WIZ BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE USE OF THIS SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Description

The aim of this script is to automate the creation of a project structure within Wiz based upon a Management Group/Organizational Unit structure held within Wiz's security graph- i.e. from a Cloud environment that is already connected to Wiz.

It also aims to build an RBAC structure based upon the user accounts that have role bindings mapped to each subscription.

## Limitations to current functionality

The script currently operates in a read-only mode and currently only focuses on the Azure Cloud Platform. The code has NOT yet been written to perform mutations on the Wiz API to actually create projects or provision users. Instead it will  generate three CSV files as follows:
* mock_project_output.csv: Details the projects it would create within Wiz.
* mock_user_output.csv: Detailing the users/roles that would be provisioned.

The idea behind generating these CSV files is so that it can be verified that the intended project structures and RBAC mappings are correct before being implemented for real.

An additional CSV file is also generated, user_import_file.csv. This is a file in a format that can then be imported into Wiz using a 
pre-existing API recipe which is at https://docs.wiz.io/wiz-docs/docs/api-recipes#bulk-create-pre-provision-saml-users-from-csv

## Output Files

* mock_project_output.csv: Details the projects that would be created within Wiz, with the following fields:
    * Project Name (string): The name of the project being created.
    * Project Path (string): The path to this project, through folder projects that contain it.
    * Is Folder (bool): Details whether this would be created as a folder project.
    * Project ID (string): A mocked identifier to this project. Intended as a placeholder to the identifier generated by Wiz when the project is created through the call to the Wiz API
    * Parent Project ID (string): Reference to the parent folder project ID that this project would be created within.

* mock_user_output.csv: Details the users/roles that would be provisioned.
    * Display Name: A human-friendly display name for the given user
    * Email Address: The user's email address
    * Role: The Wiz RBAC role mapped to this user
    * Project Path: The path to the project this role is being scoped to
    * Scoped Project ID: The project ID this role is being scoped to.


# How to run the script

It's recommended to ensure you have a Python virtualenv set up, using the `requirements.txt` file provided in this repository.

Make sure to create a Wiz Service Account with ONLY the following permission across all projects:
* Type: `Custom Integration (GraphQL API)`
* Project Scope: `All Projects`
* API Scope: `read:all`

Once loaded, create a script called `run.sh` or similar, structured similar to below:

```
export CLIENT_ID="[WIZ_CLIENT_ID]"
export CLIENT_SECRET="[WIZ_CLIENT_SECRET]"
export ROOT_MANAGEMENT_GROUP_ID="[MANAGEMENT_GROUP_ID]"
export DEFAULT_USER_ROLE="[WIZ_USER_ROLE]"
export LOGGING_LEVEL="[LOGGING_LEVEL]"

python create_folder_projects.py ${CLIENT_ID} ${CLIENT_SECRET} ${ROOT_MANAGEMENT_GROUP_ID} ${DEFAULT_SAML_PROVIDER} ${DEFAULT_USER_ROLE} ${LOGGING_LEVEL}

```

Where the [values] above align to as follows:

* WIZ_CLIENT_ID: The client id from the generated Wiz service account
* WIZ_CLIENT_SECRET: The client secret from the generated Wiz service account
* MANAGEMENT_GROUP_ID: The root management group id to start generating the folder structure from
* WIZ_USER_ROLE: The project-scoped Wiz RBAC role to assign to all users generated - it is suggested to use `ProjectReader`.
* LOGGING_LEVEL: A lower case string set to "debug", "info" "warning" "error" "critical". Leave unset to not set a logging level.