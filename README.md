# Wiz API Projects and RBAC Setup Automation

# Disclaimer - PLEASE READ

By using this software and associated documentation files (the “Software”) you hereby agree and understand that:

1. The use of the Software is free of charge and may only be used by Wiz customers for its internal purposes.
2. The Software should not be distributed to third parties.
3. The Software is not part of Wiz’s Services and is not subject to your company’s services agreement with Wiz.
4. THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL WIZ BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE USE OF THIS SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Description

The three scripts in this repository aim to assist with automating the creation of a project structure within Wiz, based upon a Managemetn Group/Organizational Unit structure held within Wiz's security graph- i.e. from a Cloud environment that is already connected to Wiz.

The scripts also aim to build an RBAC structure based upon the user accounts that have role bindings mapped to each subscription.


# Steps to follow

1. Prepare 


# Individual Script Documentation

## Script 1: 1-extract_project_adgroups_structure.py

The purpose of this script is to generate two output files:
1. A CSV representation of all projects that should be created, based upon management groups and organizational units within the AWS, Azure and GCP organizations connected to the Wiz tenant.
2. A CSV representation of all AD groups, SSO users and the projects such users/groups should be mapped to.

### Script 1: How to run the script

It's recommended to ensure you have a Python virtualenv set up, using the `requirements.txt` file provided in this repository.

Make sure to create a Wiz Service Account with ONLY the following permission across all projects:
* Type: `Custom Integration (GraphQL API)`
* Project Scope: `All Projects`
* API Scope: `read:all`

Once loaded, create a wrapper bash script called `1-run.sh` or similar, structured similar to below:

```
export WIZ_CLIENT_ID="[WIZ_CLIENT_ID]"
export WIZ_CLIENT_SECRET="[WIZ_CLIENT_SECRET]"
export AZURE_ROOT_WIZ_PROJECT_NAME = "[AZURE_ROOT_WIZ_PROJECT_NAME]"
export AZURE_ROOT_MG_LIST="[AZURE_ROOT_MG_LIST]"
export DEFAULT_SAML_PROVIDER="[SAML_PROVIDER]"
export DEFAULT_USER_ROLE="[WIZ_USER_ROLE]"
export LOGGING_LEVEL="[LOGGING_LEVEL]"
export WIZ_DATACENTER="[WIZ_DATACENTER]"
export GCP_ROOT_WIZ_PROJECT_NAME="[GCP_ROOT_WIZ_PROJECT_NAME]"
export GCP_ROOT_ORG_LIST="[GCP_ROOT_ORG_LIST]"
export AWS_ROOT_WIZ_PROJECT_NAME="[AWS_ROOT_WIZ_PROJECT_NAME]"
export AWS_ROOT_ORG_LIST="[AWS_ROOT_ORG_LIST]"
export PROJECT_OUTPUT_FILE="PROJECT_OUTPUT_FILE"
export AD_OUTPUT_FILE="AD_OUTPUT_FILE"

python 1-extract_project_adgroups_structure.py "${WIZ_CLIENT_ID}" "${WIZ_CLIENT_SECRET}" "${AZURE_ROOT_WIZ_PROJECT_NAME}" "${AZURE_ROOT_MG_LIST}" "${DEFAULT_SAML_PROVIDER}" "${DEFAULT_USER_ROLE}" "${LOGGING_LEVEL}" "${WIZ_DATACENTER}" "${GCP_ROOT_WIZ_PROJECT_NAME}" "${GCP_ROOT_ORG_LIST}" "${AWS_ROOT_WIZ_PROJECT_NAME}" "${AWS_ROOT_ORG_LIST}" "${PROJECT_OUTPUT_FILE}" "${AD_OUTPUT_FILE}"

```

Where the [values] above align to as follows:

* WIZ_CLIENT_ID: The client id from the generated Wiz service account
* WIZ_CLIENT_SECRET: The client secret from the generated Wiz service account
* AZURE_ROOT_WIZ_PROJECT_NAME: The name of the root Wiz project that will be used to group together all Azure-related folder projects and projects.
* AZURE_ROOT_MG_LIST: A JSON representation of all root management groups that should be included from Azure. For each root management group this should include a "friendly name", the provider ID of the management group and a list of "burner" management groups if applicable. Example value: `"[{\"friendly_name\": \"Azure MgtGroup A\", \"group_id\": \"tenantId/abc1234567890/providers/Microsoft.Management/managementGroups/abc1234567890\", \"burner_list\": [\"tenantId/abc1234567890/providers/Microsoft.Management/managementGroups/Burnerprojects\"]},{\"friendly_name\": \"Azure MgtGroup B\", \"group_id\": \"tenantId/abc1234567890/providers/Microsoft.Management/managementGroups/abc1234567890\",\"burner_list\":[]}]"`
* SAML_PROVIDER: The name of the SAML provider being used.
* WIZ_USER_ROLE: The project-scoped Wiz RBAC role to assign to all groupings generated by default - it is suggested to use `ProjectReader`.
* LOGGING_LEVEL: A lower case string set to "debug", "info" "warning" "error" "critical". Leave unset to not set a logging level.
* WIZ_DATACENTER: A lower case string set to the name of the Wiz DC used by your tenant (e.g. eu7)
* GCP_ROOT_WIZ_PROJECT_NAME: The name of the root Wiz project that will be used to group together all GCP-related folder projects and projects.
* GCP_ROOT_ORG_LIST: A JSON representation of all root organizations that should be included from GCP. For each root organization this should include a "friendly name", the provider ID of the management group and a list of "burner" management groups if applicable. Example value: `"[{\"friendly_name\": \"GCP Org A\", \"group_id\": \"01234567890\", \"burner_list\": [\"01234567890\"]},{\"friendly_name\": \"GCP Org B\", \"group_id\": \"01234567890\", \"burner_list\": []}]"`
* AWS_ROOT_WIZ_PROJECT_NAME: The name of the root Wiz project that will be used to group together all GCP-related folder projects and projects.
* AWS_ROOT_ORG_LIST: A JSON representation of all root organizations that should be included from AWS. For each root organization this should include a "friendly name", the provider ID of the management group and a list of "burner" management groups if applicable. Example value: `"[{\"friendly_name\": \"AWS Org A\", \"group_id\": \"r-abcd\", \"burner_list\":[]},{\"friendly_name\": \"AWS Org B\", \"group_id\": \"r-abcd\", \"burner_list\":[]},{\"friendly_name\": \"AWS Org C\", \"group_id\": \"r-abcd\", \"burner_list\":[]}]"`
* PROJECT_OUTPUT_FILE: The name of the file that you want to output the list of projects that would be created (CSV format)
* AD_OUTPUT_FILE: The name of the file that you want to output the list of user, ad group and Wiz project mappings to.

### Script 1: Expected Output

The script will output two files. 

**IMPORTANT NOTE** - The script does not validate the project names that would be created in any way. You are strongly advised to examine the outputs of script 1 and correct any duplicate project/folder-project names accordingly. Note that it is not possible to easily cater for duplicate project names through the approach we are following here, therefore these should be corrected in the output files of Script 1, prior to proceeding to Script 2.

#### Script 1: Output File 1: PROJECT_OUTPUT_FILE.csv

The output of this script will be as follows. This is the list of projects and folder projects that should be created by script 2. 

|wiz-project-name    |isFolder|cloudAccountLinks     |cloudOrganizationLinks|parentProjectName   |Full Path                                                                 |Path Depth|Cloud|
|--------------------|--------|----------------------|----------------------|--------------------|--------------------------------------------------------------------------|----------|-----|
|Colin-Turney-Azure-1|TRUE    |None                  |                      |                    |Colin-Turney-Azure-1                                                      |1         |Azure|
|Colin-Azure-MgtGroup|TRUE    |cloudaccountexternalid|                      |Colin-Turney-Azure-1|Colin-Turney-Azure-1/Colin-Azure-MgtGroup                                 |2         |Azure|
|Outpost             |TRUE    |cloudaccountexternalid|                      |Colin-Azure-MgtGroup|Colin-Turney-Azure-1/Colin-Azure-MgtGroup/Outpost                         |3         |Azure|
|Outpost             |FALSE   |cloudaccountexternalid|                      |Outpost             |Colin-Turney-Azure-1/Colin-Azure-MgtGroup/Outpost/Outpost                 |4         |Azure|
|Colin-Wiz           |FALSE   |cloudaccountexternalid|                      |Colin-Azure-MgtGroup|Colin-Turney-Azure-1/Colin-Azure-MgtGroup/Colin-Wiz                       |3         |Azure|
|CT-Mg1              |TRUE    |cloudaccountexternalid|                      |Colin-Azure-MgtGroup|Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg1                          |3         |Azure|
|CT-Mg1-Su1          |FALSE   |cloudaccountexternalid|                      |CT-Mg1              |Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg1/CT-Mg1-Su1               |4         |Azure|
|CT-Mg1-Mg1          |TRUE    |cloudaccountexternalid|                      |CT-Mg1              |Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg1/CT-Mg1-Mg1               |4         |Azure|
|CT-Mg1-Mg1-Su1      |FALSE   |cloudaccountexternalid|                      |CT-Mg1-Mg1          |Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg1/CT-Mg1-Mg1/CT-Mg1-Mg1-Su1|5         |Azure|
|CT-Mg1-Mg1-Mg1      |TRUE    |cloudaccountexternalid|                      |CT-Mg1-Mg1          |Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg1/CT-Mg1-Mg1/CT-Mg1-Mg1-Mg1|5         |Azure|
|CT-Mg2              |TRUE    |cloudaccountexternalid|                      |Colin-Azure-MgtGroup|Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg2                          |3         |Azure|
|CT-Mg2-Su1          |FALSE   |cloudaccountexternalid|                      |CT-Mg2              |Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg2/CT-Mg2-Su1               |4         |Azure|
|CT-Mg3              |TRUE    |cloudaccountexternalid|                      |Colin-Azure-MgtGroup|Colin-Turney-Azure-1/Colin-Azure-MgtGroup/CT-Mg3                          |3         |Azure|


#### Script 1: Output File 2: AD_OUTPUT_FILE.csv

|Group Name          |Wiz Project|Member Name           |Member UPN/Email        |Originating Cloud   |
|--------------------|-----------|----------------------|------------------------|--------------------|
|Wiz_ProjectName_ProjectReader|ProjectName|Colin Turney          |colin.turney@example.com|Azure               |


## Script 2: 2-create_projects.py

The purpose of this script is to take an input CSV file in the same format as Script 1 - Output File 1, and create a project and folder project structure as prescribed within that file.

export INPUT_FILENAME="recipe_input.csv"
export OUTPUT_FILENAME="recipe_output.csv"
export LOGGING_LEVEL="info"
export WIZ_DATACENTER="us20"
export WRITE_MODE="True"

python recipe_folder_projects.py "${CLIENT_ID}" "${CLIENT_SECRET}" "${INPUT_FILENAME}" "${OUTPUT_FILENAME}" "${LOGGING_LEVEL}" "${WIZ_DATACENTER}" "${WRITE_MODE}"